{"version":3,"sources":["../../../../src/react/templates/search.jsx"],"names":["RESULTS_PER_PAGE","MAX_EXCERPT_LENGTH","renderHighlightedText","lines","regex","lineNumber","Array","isArray","map","line","i","elements","unshift","split","part","SearchPage","props","state","currentQuery","lastQuery","visibleResultsCount","results","findResults","bind","handleChange","pathContext","setState","debouncing","replace","trim","RegExp","data","length","node","matches","priority","Infinity","title","test","headings","totalLength","heading","value","Math","min","depth","push","Number","isFinite","excerpt","index","search","slice","indexOf","sort","r1","r2","event","target","result","element","slug","renderResults","renderPage","React","Component"],"mappings":"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","sourcesContent":["import React from 'react';\nimport debounce from 'lodash.debounce';\nimport SearchIcon from '../components/search';\n\nimport WebsiteConfigConsumer from '../components/website-config';\nimport {\n  MainSearch,\n  SearchContainer,\n  IconContainer,\n  SearchInput,\n  SearchResultItem,\n  SearchResultLink,\n  SearchResultHighlight,\n  SearchResultPager\n} from '../styled/search';\n\nconst RESULTS_PER_PAGE = 10;\nconst MAX_EXCERPT_LENGTH = 200;\n\nfunction renderHighlightedText(lines, regex, lineNumber = 0) {\n  if (Array.isArray(lines)) {\n    return lines.map((line, i) => {\n      const elements = renderHighlightedText(line, regex, i);\n      elements.unshift(<br key={i} />);\n      return elements;\n    });\n  }\n\n  return lines.split(regex).map((part, i) => {\n    return i % 2 === 0 ? (\n      <span key={`${lineNumber}-${i}`}>{part}</span>\n    ) : (\n      <SearchResultHighlight key={`${lineNumber}-${i}`}>{part}</SearchResultHighlight>\n    );\n  });\n}\n\nexport default class SearchPage extends React.Component {\n  constructor(props) {\n    super(props);\n    this.state = {\n      currentQuery: '',\n      lastQuery: '',\n      visibleResultsCount: RESULTS_PER_PAGE,\n      results: []\n    };\n    this.findResults = debounce(this.findResults.bind(this), 250);\n    this.handleChange = this.handleChange.bind(this);\n  }\n\n  findResults(currentQuery) {\n    const {lastQuery} = this.state;\n    const {pathContext} = this.props;\n    this.setState({debouncing: false});\n    currentQuery = currentQuery\n      .replace(/[^\\w-]/g, ' ')\n      .replace(/\\s+/g, ' ')\n      .trim();\n\n    if (currentQuery === lastQuery) {\n      return;\n    }\n    let regex = null;\n    const results = [];\n    if (currentQuery) {\n      regex = new RegExp(`(${currentQuery})`, 'i');\n\n      for (let i = 0; i < pathContext.data.length; i++) {\n        const node = pathContext.data[i];\n        const matches = [];\n        let priority = Infinity;\n        if (node.title && regex.test(node.title)) {\n          priority = 0;\n        }\n        if (node.headings) {\n          let totalLength = 0;\n          for (const heading of node.headings) {\n            if (regex.test(heading.value)) {\n              priority = Math.min(priority, heading.depth);\n              totalLength += heading.value.length;\n              matches.push(heading.value);\n            }\n            if (totalLength >= MAX_EXCERPT_LENGTH) {\n              break;\n            }\n          }\n        }\n        if (!Number.isFinite(priority) && node.excerpt) {\n          const index = node.excerpt.search(regex);\n          if (index >= 0) {\n            priority = 100;\n            let excerpt = node.excerpt.slice(index - 30);\n            excerpt = excerpt.slice(excerpt.indexOf(' ') + 1).slice(0, MAX_EXCERPT_LENGTH) + '...';\n            matches.push(excerpt);\n          }\n        }\n        if (Number.isFinite(priority)) {\n          results.push({node, priority, matches});\n        }\n      }\n    }\n    results.sort((r1, r2) => r1.priority - r2.priority);\n    this.setState({\n      results,\n      regex,\n      visibleResultsCount: RESULTS_PER_PAGE,\n      lastQuery: currentQuery\n    });\n  }\n\n  handleChange(event) {\n    const currentQuery = event.target.value;\n    this.setState({currentQuery, debouncing: true});\n    this.findResults(currentQuery);\n  }\n\n  renderResults() {\n    const {results, regex, visibleResultsCount} = this.state;\n\n    return results.slice(0, visibleResultsCount).map((result) => {\n      if (!result.element) {\n        result.element = (\n          <SearchResultItem key={result.node.slug}>\n            <SearchResultLink to={`/${result.node.slug}`}>{result.node.title}</SearchResultLink>\n            {renderHighlightedText(result.matches, regex)}\n          </SearchResultItem>\n        );\n      }\n      return result.element;\n    });\n  }\n\n  renderPage() {\n    // Note: The Layout \"wrapper\" component adds header and footer etc\n    const {debouncing, results, visibleResultsCount, currentQuery} = this.state;\n    const {pathContext} = this.props;\n    return (\n      <MainSearch>\n        <SearchContainer>\n          <IconContainer>\n            <SearchIcon width={24} height={24} />\n          </IconContainer>\n          <SearchInput\n            type=\"text\"\n            placeholder=\"Search\"\n            onChange={this.handleChange}\n            value={currentQuery}\n          />\n        </SearchContainer>\n\n        {debouncing ? <div>Searching...</div> : null}\n        <div>\n          {currentQuery && !debouncing && (\n            <div>\n              {results.length ? `${results.length} articles found.` : `No result for this query.`}\n            </div>\n          )}\n\n          {!currentQuery && !debouncing && (\n            <div>{pathContext.data ? `${pathContext.data.length} articles indexed.` : ''}</div>\n          )}\n          <div>{this.renderResults()}</div>\n          {visibleResultsCount < results.length && (\n            <SearchResultPager\n              onClick={() =>\n                this.setState({\n                  visibleResultsCount: visibleResultsCount + RESULTS_PER_PAGE\n                })\n              }\n            >\n              Load more...\n            </SearchResultPager>\n          )}\n        </div>\n      </MainSearch>\n    );\n  }\n\n  render() {\n    return <WebsiteConfigConsumer>{() => this.renderPage()}</WebsiteConfigConsumer>;\n  }\n}\n"],"file":"search.js"}