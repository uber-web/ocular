{"version":3,"sources":["../../../../src/gatsby-node/on-create-webpack-config/on-create-webpack-config.js"],"names":["require","log","COLOR","MODULE_NAME","stringify","key","value","RegExp","toString","Function","priority","logWebpackConfig","stage","config","color","MAGENTA","JSON","CYAN","WEBPACK_ALIAS","WebpackRule","rule","use","test","loader","path","exclude","ocularOptions","excludeNeedsReplace","checkIfExcludes","getExcludeOverride","RED","getLoader","excludeOverride","isExcluded","ModuleRegEx","WEBPACK_EXCLUDE_REGEXP","WEBPACK_INCLUDE_REGEXP","getWebpackConfigOverrides","newConfig","module","rules","updateRuleForOcular","node","fs","aliases","webpack","resolve","alias","Object","assign","onCreateWebpackConfig","opts","global","actions","getConfig","replaceWebpackConfig","exports"],"mappings":";;;;;;;;;;;;;;AAAA,eAAqBA,OAAO,CAAC,iBAAD,CAA5B;AAAA,IAAOC,GAAP,YAAOA,GAAP;AAAA,IAAYC,KAAZ,YAAYA,KAAZ;;AAEA,IAAMC,WAAW,GAAG,qBAApB;;AAGA,SAASC,SAAT,CAAmBC,GAAnB,EAAwBC,KAAxB,EAA+B;AAC7B,MAAIA,KAAK,YAAYC,MAArB,EAA6B;AAC3B,WAAOD,KAAK,CAACE,QAAN,EAAP;AACD;;AACD,MAAIF,KAAK,YAAYG,QAArB,EAA+B;AAC7B,WAAO,YAAP;AACD;;AAGD,UAAQJ,GAAR;AACE,SAAK,cAAL;AACE,UAAIJ,GAAG,CAACS,QAAJ,GAAe,CAAnB,EAAsB;AACpB,eAAO,kBAAP;AACD;;AACD;;AACF,SAAK,SAAL;AACE,UAAIT,GAAG,CAACS,QAAJ,GAAe,CAAnB,EAAsB;AACpB,eAAO,kBAAP;AACD;;AACD;;AACF,SAAK,KAAL;AACE,UAAIT,GAAG,CAACS,QAAJ,GAAe,CAAnB,EAAsB;AACpB,eAAO,kBAAP;AACD;;AACD;;AACF;AAhBF;;AAkBA,SAAOJ,KAAP;AACD;;AAED,SAASK,gBAAT,CAA0BC,KAA1B,EAAiCC,MAAjC,EAAyC;AACvC,MAAIZ,GAAG,CAACS,QAAJ,IAAgB,CAApB,EAAuB;AACrBT,IAAAA,GAAG,CAACA,GAAJ,CACE;AAACa,MAAAA,KAAK,EAAEZ,KAAK,CAACa,OAAd;AAAuBL,MAAAA,QAAQ,EAAE;AAAjC,KADF,kBAEWE,KAFX,+BAEqCI,IAAI,CAACZ,SAAL,CAAeS,MAAf,EAAuBT,SAAvB,EAAkC,CAAlC,CAFrC;AAID,GALD,MAKO;AACLH,IAAAA,GAAG,CAACA,GAAJ,CACE;AAACa,MAAAA,KAAK,EAAEZ,KAAK,CAACe,IAAd;AAAoBP,MAAAA,QAAQ,EAAE;AAA9B,KADF,kBAEWE,KAFX,4CAEkDI,IAAI,CAACZ,SAAL,CAC9CS,MAAM,CAACK,aAAP,IAAwB,EADsB,EAE9Cd,SAF8C,EAG9C,CAH8C,CAFlD;AAQD;AACF;;IAOKe,W;;;;;;;WACJ,uBAAqBC,IAArB,EAA2B;AACzB,aAAOA,IAAI,CAACC,GAAL,IAAYD,IAAI,CAACC,GAAL,CAAS,CAAT,CAAZ,IAA2B,eAAeC,IAAf,CAAoBF,IAAI,CAACC,GAAL,CAAS,CAAT,EAAYE,MAAhC,CAAlC;AACD;;;WAED,mBAAiBH,IAAjB,EAAuB;AACrB,aAAOA,IAAI,CAACC,GAAL,IAAYD,IAAI,CAACC,GAAL,CAAS,CAAT,CAAZ,IAA2BD,IAAI,CAACC,GAAL,CAAS,CAAT,EAAYE,MAA9C;AACD;;;WAED,yBAAuBH,IAAvB,EAA6BI,IAA7B,EAAmC;AACjC,UAAOC,OAAP,GAAkBL,IAAlB,CAAOK,OAAP;;AACA,UAAIA,OAAO,IAAI,OAAOA,OAAP,KAAmB,UAAlC,EAA8C;AAC5C,eAAOA,OAAO,CAACD,IAAD,CAAd;AACD;;AACD,UAAIC,OAAO,IAAIA,OAAO,YAAYlB,MAAlC,EAA0C;AACxC,eAAOkB,OAAO,CAACH,IAAR,CAAaE,IAAb,CAAP;AACD;;AAID,aAAO,KAAP;AACD;;;WAED,yBAAuBJ,IAAvB,EAA6BI,IAA7B,EAAmC;AACjC,UAAOC,OAAP,GAAkBL,IAAlB,CAAOK,OAAP;;AACA,UAAI,OAAOA,OAAP,KAAmB,UAAvB,EAAmC;AACjC,eAAO,CAACA,OAAO,CAACD,IAAD,CAAf;AACD;;AACD,UAAIC,OAAO,YAAYlB,MAAvB,EAA+B;AAC7B,eAAO,CAACkB,OAAO,CAACH,IAAR,CAAaE,IAAb,CAAR;AACD;;AAID,aAAO,KAAP;AACD;;;WAED,6BAA2BJ,IAA3B,EAAiCM,aAAjC,EAAgD;AAM9C,UAAMC,mBAAmB,GAAGR,WAAW,CAACS,eAAZ,CAA4BR,IAA5B,yBAAkDjB,WAAlD,OAA5B;;AAGA,UAAIwB,mBAAJ,EAAyB;AACvBP,QAAAA,IAAI,CAACK,OAAL,GAAeN,WAAW,CAACU,kBAAZ,CAA+BT,IAA/B,EAAqCM,aAArC,CAAf;AACAzB,QAAAA,GAAG,CAACA,GAAJ,CACE;AAACS,UAAAA,QAAQ,EAAE,CAAX;AAAcI,UAAAA,KAAK,EAAEZ,KAAK,CAAC4B;AAA3B,SADF,+CAEwCX,WAAW,CAACY,SAAZ,CAAsBX,IAAtB,CAFxC;AAID;AACF;;;WAED,4BAA0BA,IAA1B,EAAoD;AAAA,UAApBM,aAAoB,uEAAJ,EAAI;AAClD,UAAOD,OAAP,GAAkBL,IAAlB,CAAOK,OAAP;AAEA,aAAO,SAASO,eAAT,CAAyBR,IAAzB,EAA+B;AAKpC,YAAMS,UAAU,GAAG,OAAOR,OAAP,KAAmB,UAAnB,GAAgCA,OAAO,CAACD,IAAD,CAAvC,GAAgDC,OAAO,CAACH,IAAR,CAAaE,IAAb,CAAnE;;AACA,YAAIS,UAAU,IAAI,WAAWX,IAAX,CAAgBE,IAAhB,CAAlB,EAAyC;AACvCvB,UAAAA,GAAG,CAACA,GAAJ,CAAQ,CAAR,EAAW,4BAAX,EAAyCuB,IAAzC;AACA,iBAAO,KAAP;AACD;;AACD,YAAMU,WAAW,GAAG,IAAI3B,MAAJ,CAAWJ,WAAX,CAApB;;AACA,YAAI8B,UAAU,IAAIC,WAAW,CAACZ,IAAZ,CAAiBE,IAAjB,CAAlB,EAA0C;AACxCvB,UAAAA,GAAG,CAACA,GAAJ,CAAQ,CAAR,iDAAmDuB,IAAnD;AACA,iBAAO,KAAP;AACD;;AACD,YAAIS,UAAU,IAAI,WAAWX,IAAX,CAAgBE,IAAhB,CAAlB,EAAyC;AACvCvB,UAAAA,GAAG,CAACA,GAAJ,CAAQ,CAAR,2CAA6CuB,IAA7C;AACA,iBAAO,KAAP;AACD;;AAED,YAAOW,sBAAP,GAAyDT,aAAzD,CAAOS,sBAAP;AAAA,YAA+BC,sBAA/B,GAAyDV,aAAzD,CAA+BU,sBAA/B;;AACA,YAAI,CAACH,UAAD,IAAeG,sBAAf,IAAyCA,sBAAsB,CAACd,IAAvB,CAA4BE,IAA5B,CAA7C,EAAgF;AAC9EvB,UAAAA,GAAG,CAACA,GAAJ,CAAQ,CAAR,EAAW,mCAAX,EAAgDuB,IAAhD;AACA,iBAAO,IAAP;AACD;;AACD,YAAI,CAACS,UAAD,IAAeE,sBAAf,IAAyCA,sBAAsB,CAACb,IAAvB,CAA4BE,IAA5B,CAA7C,EAAgF;AAC9EvB,UAAAA,GAAG,CAACA,GAAJ,CAAQ,CAAR,EAAW,oCAAX,EAAiDuB,IAAjD;AACA,iBAAO,IAAP;AACD;;AACD,eAAOS,UAAP;AACD,OA9BD;AA+BD;;;;;AAGH,SAASI,yBAAT,CAAmCxB,MAAnC,EAA2CyB,SAA3C,EAAsDZ,aAAtD,EAAqE;AAAA,6CAEhDb,MAAM,CAAC0B,MAAP,CAAcC,KAFkC;AAAA;;AAAA;AAEnE,wDAAwC;AAAA,UAA7BpB,IAA6B;AACtCD,MAAAA,WAAW,CAACsB,mBAAZ,CAAgCrB,IAAhC,EAAsCM,aAAtC;AACD;AAJkE;AAAA;AAAA;AAAA;AAAA;;AAQnEY,EAAAA,SAAS,CAACI,IAAV,GAAiBJ,SAAS,CAACI,IAAV,IAAkB,EAAnC;AACAJ,EAAAA,SAAS,CAACI,IAAV,CAAeC,EAAf,GAAoB,OAApB;AAEAL,EAAAA,SAAS,CAACC,MAAV,GAAmB1B,MAAM,CAAC0B,MAAP,IAAiB,EAApC;AACAD,EAAAA,SAAS,CAACC,MAAV,CAAiBC,KAAjB,GAAyB3B,MAAM,CAAC0B,MAAP,CAAcC,KAAvC;AAEA,MAAMI,OAAO,GACXlB,aAAa,CAACR,aAAd,IACCQ,aAAa,CAACmB,OAAd,IAAyBnB,aAAa,CAACmB,OAAd,CAAsBC,OAA/C,IAA0DpB,aAAa,CAACmB,OAAd,CAAsBC,OAAtB,CAA8BC,KAF3F;AAGAC,EAAAA,MAAM,CAACC,MAAP,CAAcX,SAAS,CAACQ,OAAV,CAAkBC,KAAhC,EAAuCH,OAAvC;AAEA,SAAON,SAAP;AACD;;AAGD,SAASY,qBAAT,CAA+BC,IAA/B,EAA2E;AAAA,MAAtCzB,aAAsC,uEAAtB0B,MAAM,CAAC1B,aAAe;AACzE,MACEd,KADF,GAOIuC,IAPJ,CACEvC,KADF;AAAA,MAKEyC,OALF,GAOIF,IAPJ,CAKEE,OALF;AAAA,MAMEC,SANF,GAOIH,IAPJ,CAMEG,SANF;AASA,MAAMzC,MAAM,GAAGyC,SAAS,EAAxB;AAEA,MAAMhB,SAAS,GAAGD,yBAAyB,CAACxB,MAAD,EAASA,MAAT,EAAiBa,aAAjB,CAA3C;AAGA2B,EAAAA,OAAO,CAACE,oBAAR,CAA6BjB,SAA7B;AAEA3B,EAAAA,gBAAgB,CAACC,KAAD,EAAQ0B,SAAR,CAAhB;AACD;;AAEDC,MAAM,CAACiB,OAAP,GAAiBN,qBAAjB;AAGAX,MAAM,CAACiB,OAAP,CAAe7C,gBAAf,GAAkCA,gBAAlC;AACA4B,MAAM,CAACiB,OAAP,CAAenB,yBAAf,GAA2CA,yBAA3C","sourcesContent":["const {log, COLOR} = require('../../utils/log');\n\nconst MODULE_NAME = 'gatsby-theme-ocular';\n\n// Makes JSON.stringify print regexps\nfunction stringify(key, value) {\n  if (value instanceof RegExp) {\n    return value.toString();\n  }\n  if (value instanceof Function) {\n    return '[function]';\n  }\n\n  // Prune webpack config dump\n  switch (key) {\n    case 'schemaString':\n      if (log.priority < 5) {\n        return '...logLevel<5...';\n      }\n      break;\n    case 'options':\n      if (log.priority < 4) {\n        return '...logLevel<4...';\n      }\n      break;\n    case 'use':\n      if (log.priority < 3) {\n        return '...logLevel<3...';\n      }\n      break;\n    default:\n  }\n  return value;\n}\n\nfunction logWebpackConfig(stage, config) {\n  if (log.priority >= 2) {\n    log.log(\n      {color: COLOR.MAGENTA, priority: 3},\n      `STAGE ${stage}: webpack config: ${JSON.stringify(config, stringify, 2)}`\n    )();\n  } else {\n    log.log(\n      {color: COLOR.CYAN, priority: 1},\n      `STAGE ${stage}: Webpack started with aliases ${JSON.stringify(\n        config.WEBPACK_ALIAS || {},\n        stringify,\n        2\n      )}`\n    )();\n  }\n}\n\n// See\n// https://github.com/gatsbyjs/gatsby/blob/master/docs/docs/add-custom-webpack-config.md#modifying-the-babel-loader\n// https://github.com/gatsbyjs/gatsby/issues/3052\n\n// Helper class to control what paths are processed by gatsby webpack config\nclass WebpackRule {\n  static isBabelLoader(rule) {\n    return rule.use && rule.use[0] && /babel-loader/.test(rule.use[0].loader);\n  }\n\n  static getLoader(rule) {\n    return rule.use && rule.use[0] && rule.use[0].loader;\n  }\n\n  static checkIfExcludes(rule, path) {\n    const {exclude} = rule;\n    if (exclude && typeof exclude === 'function') {\n      return exclude(path);\n    }\n    if (exclude && exclude instanceof RegExp) {\n      return exclude.test(path);\n    }\n    // Webpack conditions support more overloads: https://webpack.js.org/configuration/module#condition\n    // ignore for now\n    // console.log(exclude);\n    return false;\n  }\n\n  static checkIfIncludes(rule, path) {\n    const {exclude} = rule;\n    if (typeof exclude === 'function') {\n      return !exclude(path);\n    }\n    if (exclude instanceof RegExp) {\n      return !exclude.test(path);\n    }\n    // Webpack supports more overloads: https://webpack.js.org/configuration/module#condition\n    // ignore for now\n    // console.log(exclude);\n    return false;\n  }\n\n  static updateRuleForOcular(rule, ocularOptions) {\n    // const {WEBPACK_EXCLUDE_REGEXP, WEBPACK_INCLUDE_REGEXP} = ocularOptions;\n\n    // Uncomment to restrict to babel loaders only\n    // const isBabelLoader = WebpackRule.isBabelLoader(rule);\n\n    const excludeNeedsReplace = WebpackRule.checkIfExcludes(rule, `node_modules/${MODULE_NAME}/`);\n    // && (!WEBPACK_EXCLUDE_REGEXP || WebpackRule.checkIfIncludes(rule, WEBPACK_EXCLUDE_REGEXP));\n\n    if (excludeNeedsReplace) {\n      rule.exclude = WebpackRule.getExcludeOverride(rule, ocularOptions);\n      log.log(\n        {priority: 1, color: COLOR.RED},\n        `Replaced excludes for webpack rule ${WebpackRule.getLoader(rule)}`\n      )();\n    }\n  }\n\n  static getExcludeOverride(rule, ocularOptions = {}) {\n    const {exclude} = rule;\n    // console.log('replacing exclude', rule);\n    return function excludeOverride(path) {\n      // NOTE: site-query is included!!! but STILL DOES NOT WORK\n      // if (/site-query/.test(path)) {\n      //   console.log('site-query filtered');\n      // }\n      const isExcluded = typeof exclude === 'function' ? exclude(path) : exclude.test(path);\n      if (isExcluded && /.*\\.css$/.test(path)) {\n        log.log(4, 'Prevented exclusion of css', path)();\n        return false;\n      }\n      const ModuleRegEx = new RegExp(MODULE_NAME);\n      if (isExcluded && ModuleRegEx.test(path)) {\n        log.log(4, `Prevented exclusion of ocular gatsby ${path}`)();\n        return false;\n      }\n      if (isExcluded && /examples/.test(path)) {\n        log.log(4, `Prevented exclusion of example ${path}`)();\n        return false;\n      }\n\n      const {WEBPACK_EXCLUDE_REGEXP, WEBPACK_INCLUDE_REGEXP} = ocularOptions;\n      if (!isExcluded && WEBPACK_INCLUDE_REGEXP && WEBPACK_INCLUDE_REGEXP.test(path)) {\n        log.log(3, 'Webpack loaders will include file', path)();\n        return true;\n      }\n      if (!isExcluded && WEBPACK_EXCLUDE_REGEXP && WEBPACK_EXCLUDE_REGEXP.test(path)) {\n        log.log(3, 'Enforced webpack will exclude file', path)();\n        return true;\n      }\n      return isExcluded;\n    };\n  }\n}\n\nfunction getWebpackConfigOverrides(config, newConfig, ocularOptions) {\n  // eslint-disable-next-line no-restricted-syntax\n  for (const rule of config.module.rules) {\n    WebpackRule.updateRuleForOcular(rule, ocularOptions);\n  }\n\n  // nulling out `fs` avoids issues with certain node modules getting bundled,\n  // e.g. headless-gl gets bundled by luma.gl if installed in root folder\n  newConfig.node = newConfig.node || {};\n  newConfig.node.fs = 'empty';\n\n  newConfig.module = config.module || {};\n  newConfig.module.rules = config.module.rules;\n\n  const aliases =\n    ocularOptions.WEBPACK_ALIAS ||\n    (ocularOptions.webpack && ocularOptions.webpack.resolve && ocularOptions.webpack.resolve.alias);\n  Object.assign(newConfig.resolve.alias, aliases);\n\n  return newConfig;\n}\n\n// Looks like onCreateWebpackConfig does not receive theme options?\nfunction onCreateWebpackConfig(opts, ocularOptions = global.ocularOptions) {\n  const {\n    stage, // build stage: ‘develop’, ‘develop-html’, ‘build-javascript’, or ‘build-html’\n    // rules,     // Object (map): set of preconfigured webpack config rules\n    // loaders,   // Object (map): set of preconfigured webpack config loaders\n    // plugins,    // Object (map): A set of preconfigured webpack config plugins\n    actions,\n    getConfig // Function that returns the current webpack config\n  } = opts;\n\n  const config = getConfig();\n\n  const newConfig = getWebpackConfigOverrides(config, config, ocularOptions);\n\n  // NOTE: actions.setWebpackConfig MERGES in the new config, actions.replaceWebpackConfig SETS it\n  actions.replaceWebpackConfig(newConfig);\n\n  logWebpackConfig(stage, newConfig);\n}\n\nmodule.exports = onCreateWebpackConfig;\n\n// TODO - remove exports or move to separate files...\nmodule.exports.logWebpackConfig = logWebpackConfig;\nmodule.exports.getWebpackConfigOverrides = getWebpackConfigOverrides;\n"],"file":"on-create-webpack-config.js"}